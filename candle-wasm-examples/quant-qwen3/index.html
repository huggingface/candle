<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Qwen3 WASM Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 14px;
        }
        .header a {
            color: #667eea;
            text-decoration: none;
        }
        .main-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            min-height: 500px;
        }
        .status-bar {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status {
            font-weight: 500;
            font-size: 14px;
        }
        .status.loading { color: #856404; }
        .status.ready { color: #155724; }
        .status.error { color: #721c24; }
        .cache-info {
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        /* Chat Thread */
        .chat-thread {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .message {
            max-width: 85%;
            border-radius: 12px;
            padding: 12px 16px;
        }
        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message.assistant {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
        }
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .message.assistant .message-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Thinking Section (collapsible) */
        .thinking-wrapper {
            margin-bottom: 8px;
        }
        .thinking-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .thinking-toggle:hover {
            background: #5a6fd6;
        }
        .thinking-content {
            margin-top: 8px;
            padding: 12px;
            background: #e8ecff;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            color: #444;
        }
        .thinking-content.collapsed {
            display: none;
        }

        /* Streaming indicator */
        .streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Input Area */
        .input-area {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #userInput {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            min-height: 44px;
            max-height: 120px;
        }
        #userInput:focus {
            outline: none;
            border-color: #667eea;
        }
        .input-options {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 13px;
            color: #666;
        }
        .input-options label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .input-options input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        button.primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button.secondary {
            background: #6c757d;
            color: white;
        }
        button.secondary:hover:not(:disabled) {
            background: #5a6268;
        }
        button.danger {
            background: #dc3545;
            color: white;
        }
        button.danger:hover:not(:disabled) {
            background: #c82333;
        }
        button:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            transform: none !important;
        }
        .button-group {
            display: flex;
            gap: 8px;
        }

        /* Footer tools */
        .footer-tools {
            padding: 12px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }
        .footer-tools button {
            padding: 6px 12px;
            font-size: 12px;
        }
        #memoryInfo {
            font-family: 'Courier New', monospace;
        }

        /* Empty state */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            text-align: center;
            padding: 40px;
        }
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        .empty-state p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– Qwen3 Chat</h1>
            <p>
                Running <strong>Qwen3-0.6B</strong> in your browser via WebAssembly.
                Built with <a href="https://github.com/huggingface/candle" target="_blank">Candle</a> by <a href="https://github.com/DrJesseGlass" target="_blank">Jesse Glass</a>.
                The <a href="https://github.com/QwenLM/Qwen" target="_blank">Qwen team at Alibaba Cloud</a> developed the model
                and <a href="https://huggingface.co/unsloth" target="_blank">Unsloth</a> provided the quantized weights.
            </p>
        </div>

        <div class="main-panel">
            <!-- Status Bar -->
            <div class="status-bar">
                <span id="status" class="status loading">Initializing...</span>
                <span id="cacheInfo" class="cache-info"></span>
            </div>

            <!-- Chat Thread -->
            <div id="chatThread" class="chat-thread">
                <div class="empty-state">
                    <h3>Start a conversation</h3>
                    <p>Type a message below to begin chatting with the model.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea
                        id="userInput"
                        placeholder="Type your message... (Enter to send, Shift+Enter for newline)"
                        rows="1"
                        disabled
                    ></textarea>
                    <div class="input-options">
                        <label>
                            <input type="checkbox" id="enableThinking" checked>
                            Thinking mode
                        </label>
                        <label>
                            Max tokens:
                            <input type="number" id="maxTokens" value="500" min="1" max="2000">
                        </label>
                    </div>
                </div>
                <div class="button-group">
                    <button id="sendBtn" class="primary" onclick="sendMessage()" disabled>Send</button>
                    <button id="stopBtn" class="danger" onclick="stopGeneration()" disabled>Stop</button>
                </div>
            </div>

            <!-- Footer Tools -->
            <div class="footer-tools">
                <div>
                    <button class="secondary" onclick="newConversation()">New Chat</button>
                    <button class="secondary" onclick="showProfile()">Stats</button>
                </div>
                <span id="memoryInfo">Loading...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import init, {
            Model,
            profile_print_stats,
            profile_clear,
            get_memory_info,
            get_wasm_memory_info,
        } from './pkg/candle_wasm_example_quant_qwen3.js';

        let model = null;
        let shouldStopGeneration = false;
        let isGenerating = false;
        let messageIdCounter = 0;

        const MODEL_FILE = window.location.pathname.endsWith('/') ?
            window.location.pathname.split('/').filter(Boolean).pop() + '.gguf' :
            'Qwen3-0.6B-Q8_0.gguf';

        // ====================================================================
        // UI Helpers
        // ====================================================================

        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateCacheInfo() {
            if (!model) return;
            const cached = model.get_cached_token_count();
            const messages = model.get_message_count();
            document.getElementById('cacheInfo').textContent =
                `${messages} messages | ${cached} tokens cached`;
        }

        function updateMemory() {
            try {
                const jsMemory = get_memory_info();
                const wasmMemory = get_wasm_memory_info();
                document.getElementById('memoryInfo').textContent =
                    `${wasmMemory}`;
            } catch (e) {
                document.getElementById('memoryInfo').textContent = '';
            }
        }

        function setUIEnabled(enabled) {
            document.getElementById('userInput').disabled = !enabled;
            document.getElementById('sendBtn').disabled = !enabled;
            document.getElementById('stopBtn').disabled = enabled;
            document.getElementById('maxTokens').disabled = !enabled;
            document.getElementById('enableThinking').disabled = !enabled;
        }

        // ====================================================================
        // Chat Thread Management
        // ====================================================================

        function clearChatThread() {
            const thread = document.getElementById('chatThread');
            thread.innerHTML = `
                <div class="empty-state">
                    <h3>Start a conversation</h3>
                    <p>Type a message below to begin chatting with the model.</p>
                </div>
            `;
        }

        function addUserMessage(content) {
            const thread = document.getElementById('chatThread');

            // Remove empty state if present
            const emptyState = thread.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            thread.appendChild(messageDiv);
            thread.scrollTop = thread.scrollHeight;
        }

        function addAssistantMessage() {
            const thread = document.getElementById('chatThread');
            const id = ++messageIdCounter;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = `assistant-msg-${id}`;
            messageDiv.innerHTML = `
                <div class="thinking-wrapper" id="thinking-wrapper-${id}" style="display: none;">
                    <button class="thinking-toggle" onclick="toggleThinking(${id})">
                        <span id="thinking-arrow-${id}">â–¶</span> Reasoning
                    </button>
                    <div class="thinking-content collapsed" id="thinking-content-${id}"></div>
                </div>
                <div class="message-content" id="response-content-${id}"></div>
                <span class="streaming-indicator" id="streaming-${id}"></span>
            `;
            thread.appendChild(messageDiv);
            thread.scrollTop = thread.scrollHeight;

            return id;
        }

        function updateAssistantMessage(id, thinking, response, isComplete = false) {
            const thinkingWrapper = document.getElementById(`thinking-wrapper-${id}`);
            const thinkingContent = document.getElementById(`thinking-content-${id}`);
            const responseContent = document.getElementById(`response-content-${id}`);
            const streamingIndicator = document.getElementById(`streaming-${id}`);

            if (thinking) {
                thinkingWrapper.style.display = 'block';
                thinkingContent.textContent = thinking;
            }

            if (response) {
                responseContent.textContent = response;
            }

            if (isComplete && streamingIndicator) {
                streamingIndicator.remove();
            }

            // Auto-scroll
            const thread = document.getElementById('chatThread');
            thread.scrollTop = thread.scrollHeight;
        }

        window.toggleThinking = function(id) {
            const content = document.getElementById(`thinking-content-${id}`);
            const arrow = document.getElementById(`thinking-arrow-${id}`);

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                arrow.textContent = 'â–¼';
            } else {
                content.classList.add('collapsed');
                arrow.textContent = 'â–¶';
            }
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ====================================================================
        // Response Parsing
        // ====================================================================

        function parseResponse(fullText, enableThinking) {
            if (enableThinking) {
                const lastThinkStart = fullText.lastIndexOf('<think>');
                const lastThinkEnd = fullText.lastIndexOf('</think>');

                if (lastThinkStart > lastThinkEnd) {
                    // Still inside thinking
                    return {
                        thinking: cleanTokens(fullText),
                        response: ''
                    };
                } else if (lastThinkEnd !== -1) {
                    // Thinking complete
                    const thinkingRaw = fullText.substring(0, lastThinkEnd);
                    const responseRaw = fullText.substring(lastThinkEnd + 8);
                    return {
                        thinking: cleanTokens(thinkingRaw),
                        response: cleanTokens(responseRaw)
                    };
                } else {
                    // No tags yet
                    return {
                        thinking: cleanTokens(fullText),
                        response: ''
                    };
                }
            } else {
                return {
                    thinking: '',
                    response: cleanTokens(fullText)
                };
            }
        }

        function cleanTokens(text) {
            return text
                .replace(/<\|im_start\|>/g, '')
                .replace(/<\|im_end\|>/g, '')
                .replace(/<\|endoftext\|>/g, '')
                .replace(/<think>/g, '')
                .replace(/<\/think>/g, '')
                .trim();
        }

        // ====================================================================
        // Generation
        // ====================================================================

        window.sendMessage = async function() {
            if (!model || isGenerating) return;

            const input = document.getElementById('userInput');
            const userMessage = input.value.trim();
            if (!userMessage) return;

            // Clear input and disable UI
            input.value = '';
            input.style.height = 'auto';
            setUIEnabled(false);
            isGenerating = true;
            shouldStopGeneration = false;

            // Add user message to thread
            addUserMessage(userMessage);

            // Add assistant message placeholder
            const msgId = addAssistantMessage();
            const enableThinking = document.getElementById('enableThinking').checked;
            const maxTokens = parseInt(document.getElementById('maxTokens').value) || 500;

            try {
                updateStatus('Generating...', 'loading');
                profile_clear();
                const startTime = Date.now();

                // Start chat turn (uses KV cache efficiently!)
                // Pass enableThinking so each message can have different thinking mode
                const firstToken = model.chat(
                    userMessage,
                    0.6,    // temperature
                    0.9,    // top_p
                    1.1,    // repeat_penalty
                    64,     // repeat_last_n
                    Date.now(), // seed
                    enableThinking  // per-message thinking mode
                );

                let fullResponse = firstToken;
                let tokenCount = 1;

                // Parse and display
                let parsed = parseResponse(fullResponse, enableThinking);
                updateAssistantMessage(msgId, parsed.thinking, parsed.response);

                // Generate remaining tokens
                for (let i = 0; i < maxTokens - 1; i++) {
                    if (shouldStopGeneration) {
                        updateStatus('Stopped', 'ready');
                        break;
                    }

                    if (model.is_eos()) {
                        break;
                    }

                    const token = model.next_token();
                    fullResponse += token;
                    tokenCount++;

                    parsed = parseResponse(fullResponse, enableThinking);
                    updateAssistantMessage(msgId, parsed.thinking, parsed.response);

                    // Update status periodically
                    if (tokenCount % 10 === 0) {
                        const elapsed = (Date.now() - startTime) / 1000;
                        const tokensPerSec = (tokenCount / elapsed).toFixed(1);
                        updateStatus(`Generating... ${tokenCount} tokens (${tokensPerSec} tok/s)`, 'loading');
                        updateCacheInfo();
                        await new Promise(r => setTimeout(r, 0));
                    }
                }

                // End the turn - this records the response in conversation history
                model.end_turn();

                // Final update
                updateAssistantMessage(msgId, parsed.thinking, parsed.response, true);

                const totalTime = (Date.now() - startTime) / 1000;
                const tokensPerSec = (tokenCount / totalTime).toFixed(1);
                updateStatus(`${tokenCount} tokens in ${totalTime.toFixed(1)}s (${tokensPerSec} tok/s)`, 'ready');
                updateCacheInfo();
                updateMemory();

            } catch (e) {
                updateStatus(`Error: ${e.message}`, 'error');
                console.error('Generation error:', e);
                updateAssistantMessage(msgId, '', `Error: ${e.message}`, true);
            } finally {
                isGenerating = false;
                setUIEnabled(true);
                document.getElementById('userInput').focus();
            }
        };

        window.stopGeneration = function() {
            shouldStopGeneration = true;
        };

        window.newConversation = function() {
            if (!model) return;

            const enableThinking = document.getElementById('enableThinking').checked;
            model.start_conversation(null, enableThinking);

            clearChatThread();
            updateStatus('New conversation started', 'ready');
            updateCacheInfo();
            profile_clear();
        };

        window.showProfile = function() {
            profile_print_stats();
            console.log('Conversation JSON:', model?.get_conversation_json());
        };

        // ====================================================================
        // Input Handling
        // ====================================================================

        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Note: Thinking mode checkbox now works per-message, no need to restart conversation

        // ====================================================================
        // Model Loading
        // ====================================================================

        async function loadModel() {
            try {
                updateStatus('Initializing WASM...', 'loading');
                await init();

                updateStatus('Loading model files...', 'loading');

                const [weights, tokenizer, config] = await Promise.all([
                    fetch(MODEL_FILE).then(r => {
                        if (!r.ok) throw new Error(`Failed to load ${MODEL_FILE}`);
                        return r.arrayBuffer();
                    }),
                    fetch('tokenizer.json').then(r => {
                        if (!r.ok) throw new Error('Failed to load tokenizer');
                        return r.arrayBuffer();
                    }),
                    fetch('config.json').then(r => {
                        if (!r.ok) throw new Error('Failed to load config');
                        return r.arrayBuffer();
                    }),
                ]);

                updateStatus('Creating model...', 'loading');
                profile_clear();

                model = new Model(
                    new Uint8Array(weights),
                    new Uint8Array(tokenizer),
                    new Uint8Array(config)
                );

                // Initialize conversation
                const enableThinking = document.getElementById('enableThinking').checked;
                model.start_conversation(null, enableThinking);

                setUIEnabled(true);
                updateStatus('Ready', 'ready');
                updateCacheInfo();
                updateMemory();
                document.getElementById('userInput').focus();

            } catch (e) {
                updateStatus(`Error: ${e.message}`, 'error');
                console.error('Load error:', e);
            }
        }

        // Start loading
        loadModel();
    </script>
</body>
</html>